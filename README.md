THIS README IS STILL UNDER CONSTRUCTION, CHECK BACK SOON...


# RegressHaplo R Package

This package reconstructs haplotypes from a BAM file using a penalized regression approach.   The algorithm assumes that the BAM file reads are drawn from a low diversity population, roughly <2% diversity.  BAM files reflecting high diversity will lead to long run times and bad performance.

The penaliezd regression has the form

min_x ||y-Px||^2 + rho*J(x)

where J(x) is a quadratic penalty term.   A link with further details regarding the regression will be posted **here** shortly.  

## Installation

It's easiest to install RegressHaplo using the R package devtools.  After installing devtools, e.g. `install.packages("devtools")`, execute the following commands in R

```r
library(devtools)
install_github("SLeviyang/RegressHaplo")
```

RegressHaplo depends on the following R packages: **igraph, plyr, dplyr, ggplot2, reshape2, Biostrings**.  These packages must be installed prior to using RegressHaplo.  All are CRAN packages, which can be installed using the `install.packages` command or through the Rstudio GUI, except for Biostrings, which is a Bioconductor package and can be installed as follows:

```r
source("https://bioconductor.org/biocLite.R")
biocLite("Biostrings")
```

## Running RegressHaplo

Once RegressHaplo is installed, you must load it into your R session:

```r
library("RegressHaplo")
```
The RegressHaplo analysis is split into components comprising the following pipeline:


**BAM file --> variant calls --> read\_table --> loci --> potential haplotypes --> parameters --> solutions --> haplotypes --> fasta file**

The full pipeline can be run using the command

```r
full_pipeline(bam_file, out_dir)
```
where 

* `bam_file` - A BAM file of the NGS dataset.  The reference is not needed by RegressHaplo. 
* `out_dir` - directory in which output and input datafiles are written and read.

`full_pipeline` has several optional parameters that allow for greater control of the pipeline, see R help through `help("full_pipeline")` for further details. 


### Output Files

The following files are generated by the RegressHaplo pipeline.  The folder **data/output** contains examples of each of these files.


1. `variant_calls.csv`  A file containing a data.frame with columns: pos, A, C, G, T, -.   pos gives the position number relative to the reference.  The A,C,G,T,- columns have entries of 0 or 1 specifying if a given nucleotide is a true variant (1) or error (0). 
2. `read_table.csv`  A file containing a data.frame with columns count, pos1, pos2, ..., posn.  posi is the position of the ith variable position specified in `variant_calls.csv`.  Each row of the read\_table data.frame corresponds to a collection of reads that cover the same variable positions and have the same nucleotides at those positions.
3. `loci.csv` A file containing a data.frame with columns locus, pos.  The locus column gives the number of the locus, starting with 1 and incrementing by one.   The pos column gives the subset of variable positions (specified in `variant_calls.csv`) contained in each locus.  The format of each entry is pos1+pos2+..+posn.  For example, 100+200+220 as an entry in the pos column represents a locus containing positions 100,200,220 relative to the reference.
4. `h.csv` Each row corresponds to a potential haplotype.   Each column has the position as a header.  Columns exactly correspond to variable positions.  
3. `y.csv, P.csv` The y vector and P matrix in the least squares \|y - Ph\|^2.
4. `solutions.csv` - A file containing all solutions for the penalized regression.   Each column represents a single solution to the penalized regression.   This file should not be accessed directly, but instead should be accessed through the solution analysis functions described below.
5. `final_haplo.csv` - A csv file containing nucleotide values of reconstructed haplotypes, but only at the variable positions.  
6. `final_haplo.fasta` - A fasta file containing the reconstructed haplotypes over the whole reference.  Variable positions have nucleotide values given by `final_haplo.csv` and other positions are given the consensus value.  Each sequence in the fasta file has the form `haplotype#_frequency` where `#` is the haplotype number and `frequency` is the reconstructed haplotype frequency.


### Output Files Accessor Functions

For convenience, the following functions allow the user to access data in files produced by the RegressHaplo pipeline:

1. `get_variant_calls.pipeline(out_dir)` - returns the data.frame written in `variant_calls.csv`.
2. `get_read_table.pipeline(out_dir)` - returns the data.frame written in `read_table.csv`.
3. `get_loci.pipeline(out_dir)` - returns a list of numeric vectors giving the positions, relative to the reference, composing each loci.  
4. `get_y.pipeline(out_dir), get_P.pipeline(out_dir)` - return a numeric vector, the y vector, and a numeric vector, the P matrix.  These functions access `y.csv` and `P.csv` respectively
5. `get_solutions.pipeline(out_dir)` - returns matrix containing solution information.  This function is offered for completeness, analysis of solutions should be done through the solution analysis functions described below.
6. `get_fasta.pipeline(out_dir)` - returns a list containing the list elements `haplotypes` and `freq`.  `haplotypes` is a character.vector, each entry of which gives a full haplotype covering the reference.  `freq` is a numeric.vector giving the inferred frequency of each haplotype.

## Pipeline Components

Greater control of RegressHaplo can be acheived by running the pipeline components separately.  Each pipeline component takes the output of the previous pipeline components as its input, thereby allowing a user to replace any given pipeline component with their own analysis.  For example, variant calling can be done with another tool.  

**Pipeline Component Functions**:

1.  `bam_to_variant_calls.pipeline(bam_file, out_dir)` - outputs **variant\_calls.csv**.
2. `variant_calls_to_read_table.pipeline(bam_file, out_dir)` - outputs **read\_table.csv**.
3. `read_table_to_loci.pipeline(out_dir)` - outputs **loci.csv**.
4. `loci_to_haplotypes.pipeline(out_dir)` - outputs **h.csv**.
5. `haplotypes_to_parameters.pipeline(out_dir)` - outputs **y.csv, P.csv**
6. `parameters_to_solutions.pipeline(out_dir, num_trials=100)` - outputs **solutions.csv**
7. `solutions_to_haplotypes.pipeline(out_dir)` - outputs **final_haplo.csv**
8. `haplotypes_to_fasta.pipeline(bam_file, out_dir)` - outputs **final_haplo.fasta**

**The pipeline component functions have further parameters that allow for greater control of the output.   Use the R help command to see details for each function.**

## Solution Analysis Functions

We provide functions to analyze the many solutions produced (saved in `solutions.csv`.   Analysis of solutions insures that a sufficient number of starting values have been tested and that overfitting, usually by too many haplotypes, is prevented.

1. `get_solutions_summary.pipeline(out_dir)` - A data.frame with columns (rho) rho value for fitting,(K) number of haplotypes reconstruted, (kk) technical parameter, (fit) fit of haplotype reconstruction, (solution_number).  Each row of the data.frame corresponds to a solution of the optimization for a given starting point and rho value.
2. `get_solutions_haplotype_reconstruction(out_dir)` - returns a data.frame with columns (haplotype) haplotypes reconstructed and (freq) frequencies of haplotype

## Example


